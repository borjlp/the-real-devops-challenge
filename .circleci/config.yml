version: 2.1

executors:
  builder:
    docker:
      - image: circleci/python
  tester:
    docker:
      - image: painless/tox 
        environment: 
          MONGO_URI: "mongodb://localhost:27017/"
      - image: mongo:4.4.8

jobs:
  test:  
    executor: tester
    steps:
      - checkout
      - restore_cache:
          keys:
            - tox-{{ checksum "src/requirements_dev.txt" }}-{{ checksum "src/requirements.txt" }}
      - run:
          name: Run tests
          command: tox -p auto .
      - run:
          name: Install codecov
          command: pip install codecov
      - run:
          name: Send coverage
          command: codecov
      - save_cache:
          key: tox-{{ checksum "src/requirements_dev.txt" }}-{{ checksum "src/requirements.txt" }}
          paths:
            - ~/project/.tox

  build-compose:
    executor: builder
    steps:
      - setup_remote_docker:
          version: 20.10.6
          docker_layer_caching: true
      - checkout
      - run:
          name: Run compose
          command: |
            set -x
            docker-compose build
            docker-compose up -d 
            docker run --network project_app curlimages/curl:latest \
              curl -s http://app:8080/api/v1/restaurant/55f14312c7447c3da7051b26


workflows:
  test-and-build: 
    jobs:
      - test
      - build-compose
